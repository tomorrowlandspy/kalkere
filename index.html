<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Survey Link Generator</title>
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 15px;
        background-color: #f8f9fa;
        color: #333;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    h1 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 20px;
        font-weight: 600;
    }
    .filter-container {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .filter-label {
        font-size: 14px;
        color: #555;
    }
    .filter-select {
        font-size: 14px;
        padding: 5px 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        background: white;
    }
    .file-section {
        margin-bottom: 20px;
    }
    .file-input-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 15px;
    }
    .file-label {
        font-size: 14px;
        color: #333;
        background: #f0f0f0;
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        cursor: pointer;
        text-align: center;
        transition: background 0.2s;
    }
    .file-label:hover {
        background: #e8e8e8;
    }
    input[type="file"] {
        display: none;
    }
    .file-name {
        font-size: 13px;
        color: #666;
        padding: 6px 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .button-group {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
    }
    .btn {
        padding: 8px 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        background: #f8f8f8;
        color: #333;
        transition: all 0.2s;
    }
    .btn:hover {
        background: #f0f0f0;
    }
    .btn-primary { 
        background-color: #007bff; 
        color: white; 
        border-color: #007bff;
    }
    .btn-primary:hover { 
        background-color: #0056b3; 
    }
    .btn-success { 
        background-color: #28a745; 
        color: white; 
        border-color: #28a745;
    }
    .btn-success:hover { 
        background-color: #1e7e34; 
    }
    .btn-warning { 
        background-color: #ffc107; 
        color: #333; 
        border-color: #ffc107;
    }
    .btn-warning:hover { 
        background-color: #e0a800; 
    }
    .btn:disabled { 
        background-color: #e9ecef; 
        color: #6c757d;
        cursor: not-allowed; 
        border-color: #dee2e6;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        border: 1px solid #dee2e6;
        font-size: 13px;
    }
    th, td {
        border: 1px solid #dee2e6;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f8f9fa;
        color: #333;
        font-weight: 600;
    }
    .copy-btn {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s;
    }
    .copy-btn:hover { 
        background-color: #5a6268; 
    }
    .copy-btn.copied {
        background-color: #28a745;
        cursor: not-allowed;
    }
    .copy-btn:disabled {
        background-color: #ced4da;
        color: #6c757d;
        cursor: not-allowed;
    }
    .status {
        margin: 10px 0;
        padding: 8px;
        border-radius: 4px;
        font-size: 13px;
    }
    .status.success { 
        background-color: #d4edda; 
        color: #155724; 
        border: 1px solid #c3e6cb;
    }
    .status.error { 
        background-color: #f8d7da; 
        color: #721c24; 
        border: 1px solid #f5c6cb;
    }
    .status.info { 
        background-color: #d6eaf8; 
        color: #2980b9; 
        border: 1px solid #3498db;
    }
    .table-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    .summary {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        border-left: 3px solid #007bff;
        font-size: 13px;
    }
    .summary h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 600;
    }
    .summary p {
        margin: 4px 0;
    }

    @media (max-width: 768px) {
        .container {
            padding: 15px;
        }
        .button-group {
            flex-direction: column;
        }
        .btn {
            width: 100%;
        }
        .filter-container {
            flex-wrap: wrap;
        }
        table {
            font-size: 12px;
        }
        th, td {
            padding: 6px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <h1>ARYA STARK WINTER FELL</h1>

    <div class="filter-container">
        <label for="salesTypeFilter" class="filter-label">Filter:</label>
        <select id="salesTypeFilter" class="filter-select">
            <option value="ALL">All</option>
            <option value="DINE-IN">DINE-IN</option>
            <option value="TAKEAWAY">TAKEAWAY</option>
            <option value="DELIVERY">DELIVERY</option>
        </select>
    </div>

    <div class="file-section">
        <div class="file-input-container">
            <label for="fileInput" class="file-label">üìÅ Choose Excel File</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <div class="file-name" id="fileName">No file chosen</div>
        </div>
        <div class="button-group">
            <button class="btn btn-primary" id="generateBtn" onclick="processFile()" disabled>Generate Links</button>
            <button class="btn btn-warning" onclick="clearData()">Clear All</button>
        </div>
    </div>
    
    <div id="status" class="status" style="display: none;"></div>
    
    <div class="summary" id="summary" style="display: none;"></div>
    
    <div class="button-group">
        <button class="btn btn-success" id="copyAllBtn" onclick="copyAllLinks()" disabled>Copy All Links</button>
        <button class="btn btn-primary" onclick="exportToCSV()" id="exportBtn" disabled>Export to CSV</button>
    </div>
    
    <div class="table-container">
        <table id="linkTable">
            <thead>
                <tr>
                    <th>Receipt No.</th>
                    <th>Sales Type</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let currentData = [];
let allData = [];
const storeID = "91KDIPL1067-01";

function getRowValue(row, possibleKeys) {
    for (const key of possibleKeys) {
        if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
            return row[key];
        }
    }
    return null;
}

function generateSurveyLink(row) {
    const receiptNo = getRowValue(row, ['Receipt No.', 'Receipt No', 'ReceiptNo']);
    const salesType = getRowValue(row, ['Sales Type', 'SalesType']);
    
    if (!receiptNo || !salesType) {
        return null;
    }

    let surveyModel = '', orderID = '', numericOT = '';

    if (/^\d+$/.test(receiptNo) && salesType === 'TAKEAWAY') { 
        surveyModel = '6.0'; 
        orderID = receiptNo; 
        numericOT = '2'; 
    }
    else if (/^\d+$/.test(receiptNo) && salesType === 'DINE-IN') { 
        surveyModel = '6.0'; 
        orderID = receiptNo; 
        numericOT = '1'; 
    }
    else if (receiptNo.startsWith('K855') && salesType === 'TAKEAWAY') { 
        surveyModel = '4.0'; 
        orderID = receiptNo.slice(-4); 
        numericOT = '2'; 
    }
    else if (receiptNo.startsWith('K855') && salesType === 'DINE-IN') { 
        surveyModel = '4.0'; 
        orderID = receiptNo.slice(-4); 
        numericOT = '1'; 
    }
    else if (receiptNo.startsWith('K855') && salesType === 'DELIVERY') { 
        surveyModel = '3.0'; 
        orderID = receiptNo; 
        numericOT = '3'; 
    }
    else { 
        return null; 
    }

    const rawDate = getRowValue(row, ['Date', 'Transaction Date']);
    const rawTime = getRowValue(row, ['Time', 'Transaction Time']);
    
    let date = '', time = '', isoDateTime = '';
    
    if (rawDate) {
        if (typeof rawDate === 'string') {
            date = rawDate.split(' ')[0];
        } else {
            date = convertExcelDate(rawDate);
        }
    }
    if (rawTime) {
        if (typeof rawTime === 'string') {
            time = rawTime.split('.')[0];
        } else {
            time = convertExcelTime(rawTime);
        }
    }
    if (date && time) {
        isoDateTime = `${date}T${time}Z`;
    }

    const phoneRaw = getRowValue(row, ['Sell-to Contact No.', 'Sell-to Contact No', 'ContactNo']);
    const phoneNumber = phoneRaw ? `91${phoneRaw}` : '';

    const data = { 
        "S": storeID, 
        "OI": orderID, 
        "D": date, 
        "TM": time, 
        "DTM": isoDateTime, 
        "TI": orderID, 
        "OT": numericOT, 
        "SM": surveyModel, 
        "PH": phoneNumber 
    };
    
    const encodedData = btoa(JSON.stringify(data));
    return `https://customer.kfc-listens.com/jfe/form/SV_8bHC0noyvM3jPWC?Q_EED=${encodedData}`;
}

function convertExcelDate(serial) {
    const date = new Date((serial - 25569) * 86400 * 1000);
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

function convertExcelTime(serial) {
    const totalMilliseconds = Math.round(serial * 24 * 60 * 60 * 1000);
    const hours = String(Math.floor(totalMilliseconds / (60 * 60 * 1000))).padStart(2,'0');
    const minutes = String(Math.floor((totalMilliseconds % (60 * 60 * 1000)) / (60 * 1000))).padStart(2,'0');
    const seconds = String(Math.floor((totalMilliseconds % (60 * 1000)) / 1000)).padStart(2,'0');
    return `${hours}:${minutes}:${seconds}`;
}

function shouldFilterOutRow(row) {
    const posReceipt = getRowValue(row, ['POS Receipt No.', 'POS Receipt No', 'POSReceiptNo']);
    if (posReceipt) {
        if (typeof posReceipt === 'string') {
            if (posReceipt.includes('K855SWG') || 
                posReceipt.includes('K855ZMT') || 
                posReceipt.includes('K855MAGIC') ||
                /K855SWG/i.test(posReceipt) ||
                /K855ZMT/i.test(posReceipt) ||
                /K855MAGIC/i.test(posReceipt)) {
                return true;
            }
        }
    }
    return false;
}

function processFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return showStatus('Please select a file first', 'error');
    showStatus('Processing file...', 'info');

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            let headerRowIndex = -1;
            let dataStartRow = -1;
            
            for (let R = range.s.r; R <= range.e.r; ++R) {
                const cellAddress = XLSX.utils.encode_cell({c: 0, r: R});
                const cell = worksheet[cellAddress];
                if (cell && cell.v === "Transaction No.") {
                    headerRowIndex = R;
                    dataStartRow = R + 1;
                    break;
                }
            }
            
            if (headerRowIndex === -1) {
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    const cellAddress = XLSX.utils.encode_cell({c: 0, r: R});
                    const cell = worksheet[cellAddress];
                    if (cell && typeof cell.v === 'string' && 
                        (cell.v.includes("Transaction") || cell.v.includes("Receipt"))) {
                        headerRowIndex = R;
                        dataStartRow = R + 1;
                        break;
                    }
                }
                
                if (headerRowIndex === -1) {
                    headerRowIndex = 2;
                    dataStartRow = 3;
                }
            }
            
            const newRange = XLSX.utils.encode_range({
                s: {c: range.s.c, r: headerRowIndex},
                e: {c: range.e.c, r: range.e.r}
            });
            worksheet['!ref'] = newRange;
            
            const sheetData = XLSX.utils.sheet_to_json(worksheet);
            console.log("Total rows in sheet:", sheetData.length);

            allData = [];
            let processedCount = 0;
            let errorCount = 0;
            let filteredCount = 0;

            sheetData.forEach((row, index) => {
                try {
                    if (shouldFilterOutRow(row)) {
                        filteredCount++;
                        console.log("Filtered out row:", row);
                        return;
                    }
                    
                    const link = generateSurveyLink(row);
                    if (link) {
                        processedCount++;
                        const linkData = {
                            receiptNo: getRowValue(row, ['Receipt No.', 'Receipt No', 'ReceiptNo']),
                            salesType: getRowValue(row, ['Sales Type', 'SalesType']),
                            link: link,
                            copied: false
                        };
                        allData.push(linkData);
                        console.log("Generated link for:", linkData.receiptNo, linkData.salesType);
                    } else {
                        errorCount++;
                        console.log("Failed to generate link for row:", row);
                    }
                } catch (err) {
                    errorCount++;
                    console.error("Error processing row:", err, row);
                }
            });

            console.log("Processing complete:", {
                total: sheetData.length,
                processed: processedCount,
                filtered: filteredCount,
                errors: errorCount
            });

            filterLinks();

            updateSummary(processedCount, errorCount, filteredCount, sheetData.length);
            
            if (processedCount > 0) {
                showStatus(`Generated ${processedCount} links (Filtered: ${filteredCount})`, 'success');
                document.getElementById('copyAllBtn').disabled = false;
                document.getElementById('exportBtn').disabled = false;
            } else {
                showStatus(`No valid records found. Filtered: ${filteredCount}`, 'error');
            }
        } catch (err) {
            console.error("Error processing file:", err);
            showStatus('Error processing file: ' + err.message, 'error');
        }
    };
    
    reader.onerror = function() {
        console.error("Error reading file");
        showStatus('Error reading file', 'error');
    };
    
    reader.readAsArrayBuffer(file);
}

function renderTable(filteredData) {
    const tbody = document.querySelector('#linkTable tbody');
    tbody.innerHTML = '';
    
    if (filteredData.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="3" style="text-align: center; color: #666;">No data to display</td>`;
        tbody.appendChild(tr);
        return;
    }
    
    filteredData.forEach((linkData, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${linkData.receiptNo}</td>
            <td>${linkData.salesType}</td>
            <td><button class="copy-btn" data-index="${idx}">Copy Link</button></td>
        `;
        tbody.appendChild(tr);
    });
    
    document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            copyIndividualLink(index, this);
        });
    });
}

function filterLinks() {
    const filter = document.getElementById('salesTypeFilter').value;
    console.log("Applying filter:", filter, "Total data:", allData.length);
    
    if (filter === "ALL") {
        currentData = allData.slice();
    } else {
        currentData = allData.filter(item => item.salesType === filter);
    }
    
    console.log("Filtered data:", currentData.length);
    renderTable(currentData);
    
    document.getElementById('copyAllBtn').disabled = currentData.length === 0;
    document.getElementById('exportBtn').disabled = currentData.length === 0;
}

function updateSummary(processed, errors, filtered, total) {
    const summaryEl = document.getElementById('summary');
    summaryEl.innerHTML = `
        <h3>Summary</h3>
        <p><strong>Total Records:</strong> ${total}</p>
        <p><strong>Successfully Processed:</strong> ${processed}</p>
        <p><strong>Filtered Out:</strong> ${filtered}</p>
        <p><strong>Errors/Skipped:</strong> ${errors}</p>
    `;
    summaryEl.style.display = 'block';
}

function copyIndividualLink(index, button) {
    const linkData = currentData[index];
    if (linkData.copied) { return; }
    const link = linkData.link;
    
    navigator.clipboard.writeText(link).then(() => {
        linkData.copied = true;
        button.textContent = 'Copied!';
        button.classList.add('copied');
        button.disabled = true;
        showStatus('Link copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy:', err);
        showStatus('Failed to copy link', 'error');
    });
}

function copyAllLinks() {
    const links = currentData.map(item => item.link).join('\n');
    
    navigator.clipboard.writeText(links).then(() => {
        currentData.forEach((item) => {
            item.copied = true;
        });
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.textContent = 'Copied!';
            button.classList.add('copied');
            button.disabled = true;
        });
        showStatus('All links copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy all:', err);
        showStatus('Failed to copy all links', 'error');
    });
}

function exportToCSV() {
    if (currentData.length === 0) return showStatus('No data to export', 'error');
    
    let csvContent = "Receipt No.,Sales Type,Generated Link\n";
    currentData.forEach(row => {
        csvContent += `"${row.receiptNo}","${row.salesType}","${row.link}"\n`;
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "survey_links.csv");
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showStatus('CSV exported successfully!', 'success');
}

function clearData() {
    currentData = [];
    allData = [];
    document.querySelector('#linkTable tbody').innerHTML = '';
    document.getElementById('fileInput').value = '';
    document.getElementById('fileName').textContent = 'No file chosen';
    document.getElementById('copyAllBtn').disabled = true;
    document.getElementById('exportBtn').disabled = true;
    document.getElementById('generateBtn').disabled = true;
    document.getElementById('status').style.display = 'none';
    document.getElementById('summary').style.display = 'none';
}

function showStatus(message, type) {
    const statusEl = document.getElementById('status');
    statusEl.textContent = message;
    statusEl.className = `status ${type}`;
    statusEl.style.display = 'block';
    
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 5000);
    }
}

document.getElementById('fileInput').addEventListener('change', function() {
    const fileName = this.files.length > 0 ? this.files[0].name : 'No file chosen';
    document.getElementById('fileName').textContent = fileName;
    document.getElementById('generateBtn').disabled = !this.files.length;
});

document.getElementById('salesTypeFilter').addEventListener('change', filterLinks);
</script>
</body>
</html>
